<style>
  .old-sentence {
    text-decoration: line-through;
  }
  .new-sentence {
    background: #ffffaa;
  }
</style>

<h1><%= @priority.name %></h1>

<% for action in @actions %>
  <h2><%= action[:action] %></h2>
  <div style="font-size:8pt;text-transform:uppercase;padding: 5px 0;">
    <%= "Grein: #{action[:gr].inspect} &bull;" if action[:gr] %>
    <%= "Málsgrein: #{action[:mgr].inspect} &bull;" if action[:mgr] %>
    <%= "Málsliður: #{action[:malsl].inspect} &bull;" if action[:malsl] %>
    <%= "Töluliður: #{action[:tolul].inspect} &bull;" if action[:tolul] %>
  </div>
  <%

    def parse_action(action, law_element)
      old_text = ""
      new_text = ""

      case action[:action]
      when :replace_all
        old_text = "<span class=\"old-sentence\">#{law_element.clone}</span>"
        new_text = "<span class=\"new-sentence\">#{action[:new_text]}</span>"
        # law_elements[action[element_type].last.to_i-1] += "<span class=\"new-sentence\">#{new_text}</span>"
      when :replace_inline
        old_text = action[:inline_text]
        # law_element.gsub!(action[:inline_text], "<span class=\"old-sentence\">#{old_text}</span><span class=\"new-sentence\">#{new_text}")
      end

      { :old_text => old_text, :new_text => new_text }
    end


    def parse_text(action, element_type, law_elements, article_id = 0, paragraph_id = 0, item_id = 0)
      results = []
      old_text = ""
      sentences = action[element_type]

      sentences.each { |sentence_id|
        case element_type
        when :mgr
          paragraph_id = sentence_id.to_i
        when :tolul
          item_id = sentence_id.to_i
        end
        results = parse_action(action, law_elements[article_id][paragraph_id][item_id][:text])
        law_elements[article_id][paragraph_id][item_id][:text] = results[:old_text]
        old_text = "#{old_text}#{results[:old_text]}"
      }

      case element_type
      when :mgr
        paragraph_id = action[element_type].last.to_i
      when :tolul
        item_id = action[element_type].last.to_i
      end

      law_elements[article_id][paragraph_id][item_id][:text] += results[:new_text] if results and not results[:new_text].blank?

      old_text
    end

    def parse_sentences(action, element_type, law_elements)
      results = []
      old_text = ""
      sentences = action[element_type]

      sentences.each { |sentence_id|
        results = parse_action(action, law_elements[sentence_id.to_i-1])
        law_elements[sentence_id.to_i-1] = results[:old_text]
        old_text = "#{old_text}#{results[:old_text]}"
      }

      law_elements[action[element_type].last.to_i-1] += results[:new_text] if results and not results[:new_text].blank?

      old_text
    end


    old_text = ""

    # Grein / Article
    if action[:gr]
      action[:gr].each { |article|
        # Málsgrein / Paragraph
        if action[:mgr]
          action[:mgr].each { |paragraph|
            # Töluliður / List Item
            if action[:tolul]
              action[:tolul].each { |item|
                # Málsliður / Sentence
                if action[:malsl]
                  old_text = parse_sentences(action, :malsl, @law_elements[article.to_i][paragraph.to_i][item.to_i][:sentences])
                else
                  # old_text = parse_text(action, @law_elements[article.to_i][paragraph.to_i][item.to_i])
                  # old_text = "#{old_text}#{@law_elements[article.to_i][paragraph.to_i][item.to_i][:text]}" if @law_elements[article.to_i][paragraph.to_i][item.to_i]
                end
              }
            else
              # Málsliður / Sentence
              if action[:malsl]
                old_text = parse_sentences(action, :malsl, @law_elements[article.to_i][paragraph.to_i][0][:sentences])
              else
                old_text = "#{old_text}#{@law_elements[article.to_i][paragraph.to_i][0][:text]}" if @law_elements[article.to_i][paragraph.to_i][0]
              end
            end
          }
          # Málsgreinar
          old_text = parse_text(action, :mgr, @law_elements, article.to_i)
        else
          # # text = "#{text}#{@law_elements[article.to_i][0][0][:text]}" if @law_elements[article.to_i][0][0]
        end
      }
    end
  %>
  <p><strong>GAMALT:</strong><br />
  <%= old_text %></p>
  <br />
  <p><strong>GAMALT inline:</strong><br />
  <%= action[:inline_text] %></p>
  <br />
  <p><strong>NÝTT:</strong><br />
  <%= action[:new_text] %></p>
<% end %>

<hr />

<% @law_elements.each_with_index do |element,index| %>
  <% if index > 0 %>
    <p><strong><%= index %> gr.</strong></p><br />
    <% element.each_with_index do |paragraph,pindex| %>
      <% paragraph.each_with_index do |item,iindex| %>
        <p <%= "style='padding-left:20px'" if iindex > 0 %>>
          <% item[:sentences].each do |sentence| %>
            <span class="sentence"><%= sentence %></span>
          <% end %>
        </p>
        <br />
      <% end if paragraph %>
    <% end if element %>
  <% end %>
<% end %>

<hr />

<%= @law_elements.inspect %>